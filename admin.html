<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ğŸª ê´€ë¦¬ì ì½˜ì†”</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --sky:#e6f4ff; --gold:#ffe58f; --text:#0f172a; --muted:#6b7280;
      --card:#ffffff; --border:#e5e7eb; --shadow:0 8px 20px rgba(0,0,0,.06); --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:24px auto; max-width:1080px;
      font-family:ui-sans-serif,system-ui,AppleSDGothicNeo,Segoe UI,Arial;
      color:var(--text); background:linear-gradient(180deg,var(--sky),#fff 60%);
    }
    h1{margin:0 0 16px; font-size:28px}
    .muted{color:var(--muted)}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding:16px;
    }
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:16px}
    input,select,button{
      border:1px solid var(--border); border-radius:12px; padding:10px;
      font-size:14px; background:#fff;
    }
    button{
      cursor:pointer; transition:.2s; font-weight:600;
      background:linear-gradient(180deg,#fff,var(--gold));
      border-color:#f4d76b;
    }
    button:hover{transform:translateY(-1px)}
    button:disabled{opacity:.45; cursor:not-allowed; transform:none;}
    .btn-primary{
      background:linear-gradient(180deg,#fff,var(--sky));
      border-color:#b6ddff;
    }
    .pill{
      display:inline-block; padding:4px 10px; border-radius:999px;
      background:#fff; border:1px solid var(--border); font-size:12px;
    }
    table{width:100%; border-collapse:collapse}
    th,td{border:1px solid var(--border); padding:8px; font-size:14px; vertical-align:top}
    th{background:#f8fbff}
    .thumb{width:80px; height:56px; object-fit:cover; border-radius:10px; border:1px solid var(--border)}
    .badge{background:var(--gold); border:1px solid #f2cc5e; padding:2px 8px; border-radius:999px; font-size:12px}
    .key-box{
      background:#f8fbff; border:1px solid #c9e6ff; border-radius:16px;
      padding:12px; margin:0 0 16px;
    }
    .hide{display:none !important;}
    .btn-mini{padding:6px 10px; border-radius:10px; font-size:13px;}
    .help{
      font-size:12px; color:var(--muted); line-height:1.35;
      background:#fbfdff; border:1px dashed #c9e6ff; padding:10px; border-radius:12px;
      width:100%;
    }
  </style>

  <script src="js/config.js"></script>
  <script src="js/api.js"></script>
</head>

<body>
  <h1>ğŸª ê´€ë¦¬ì ì½˜ì†” <span class="badge">ì‹¤ì‹œê°„</span></h1>
  <p class="muted">ì´ê´€ë¦¬ì(ë§ˆìŠ¤í„°í‚¤)ëŠ” ë¶€ìŠ¤ ìƒì„± / ë¶€ìŠ¤ìš´ì˜ì(ë¶€ìŠ¤í‚¤)ëŠ” ìê¸° ë¶€ìŠ¤ë§Œ ì˜µì…˜Â·ëŒ€ê¸°ì—´Â·ì²˜ë¦¬Â·ì·¨ì†Œ ê°€ëŠ¥</p>

  <div class="key-box">
    <div class="row">
      <input id="adminKey" placeholder="ê´€ë¦¬ì í‚¤(ë§ˆìŠ¤í„°í‚¤ ë˜ëŠ” ë¶€ìŠ¤í‚¤)" style="min-width:320px">
      <button id="saveKey" class="btn-primary">í‚¤ ì €ì¥</button>
      <button id="clearKey">í‚¤ ì§€ìš°ê¸°</button>
      <span class="pill" id="apiInfo" style="margin-left:auto"></span>
    </div>
    <div class="row" style="margin-top:8px">
      <span class="pill" id="roleInfo"></span>
    </div>
  </div>

  <div class="grid">
    <section class="card">
      <h2 style="margin:0 0 10px">ë¶€ìŠ¤/ì˜µì…˜(í•­ëª©) ê´€ë¦¬</h2>

      <div id="boothCreateBox">
        <h3 style="margin:10px 0 6px">ë¶€ìŠ¤ ë“±ë¡ (ì´ê´€ë¦¬ìë§Œ)</h3>
        <div class="row">
          <input id="b_id" placeholder="ë¶€ìŠ¤ID">
          <input id="b_name" placeholder="ë¶€ìŠ¤ëª…" style="flex:1">
          <input id="b_cap" type="number" min="0" placeholder="ì •ì›(ì„ íƒ)">
        </div>
        <div class="row" style="margin-top:8px">
          <input id="b_desc" placeholder="ì„¤ëª…(ì„ íƒ)" style="flex:1">
        </div>
        <div class="row" style="margin-top:8px">
          <input type="file" id="b_img" accept=".png,.jpg,.jpeg,.webp,.gif">
          <button id="b_img_upload">ì´ë¯¸ì§€ ì—…ë¡œë“œ</button>
          <input id="b_img_url" placeholder="imageUrl" style="flex:1">
        </div>
        <div class="row" style="margin-top:8px">
          <button id="b_add">ë¶€ìŠ¤ ë“±ë¡</button>
          <button id="b_refresh" class="btn-primary">ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <div id="boothList" style="margin-top:10px"></div>
        <hr style="margin:18px 0">
      </div>

      <h3 style="margin:10px 0 6px">ì˜µì…˜(í•­ëª©) ë“±ë¡</h3>
      <div class="row">
        <select id="m_booth"></select>
        <input id="m_id" placeholder="ì˜µì…˜ID">
        <input id="m_name" placeholder="ì˜µì…˜ëª… (ì˜ˆ: ì¹˜í‚¨/ì…ì¥ 1ì¸/ì²´í—˜ 1ì¸)">
        <input id="m_price" type="number" min="0" placeholder="ê°€ê²©(ë˜ëŠ” 1ì¸ë‹¹)">
        <input id="m_maxQty" type="number" min="0" placeholder="1ì¸ ìµœëŒ€ìˆ˜ëŸ‰(0=ë¬´ì œí•œ)" style="width:220px">
      </div>

      <div class="row" style="margin-top:8px">
        <input type="file" id="m_img" accept=".png,.jpg,.jpeg,.webp,.gif">
        <button id="m_img_upload">ì´ë¯¸ì§€ ì—…ë¡œë“œ</button>
        <input id="m_img_url" placeholder="imageUrl" style="flex:1">
      </div>

      <div class="row" style="margin-top:8px">
        <div class="help">
          â€¢ "1ì¸ ìµœëŒ€ìˆ˜ëŸ‰": í•œ ì‚¬ëŒì´ ì´ ì˜µì…˜ì„ ìµœëŒ€ ëª‡ ê°œê¹Œì§€ ì„ íƒ ê°€ëŠ¥í•˜ê²Œ ì œí•œ (ì˜ˆ: 5)
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <button id="m_add">ì˜µì…˜ ë“±ë¡</button>
        <button id="m_list" class="btn-primary">í•´ë‹¹ ë¶€ìŠ¤ ì˜µì…˜ ë³´ê¸°</button>
      </div>

      <div id="menuList" style="margin-top:10px"></div>
    </section>

    <section class="card">
      <div class="row">
        <h2 style="margin:0">ë¶€ìŠ¤ë³„ ì˜ˆì•½ (ì‹¤ì‹œê°„)</h2>
        <span class="pill" id="salesInfo" style="margin-left:auto">ë§¤ì¶œ: -</span>
        <select id="selBooth"></select>
        <button id="pauseBtn" class="btn-primary">ëŒ€ê¸°ì—´ ì¤‘ì§€</button>
        <button id="resumeBtn" class="btn-primary">ì¬ê°œ</button>
      </div>
      <div id="resvBox" style="margin-top:10px"></div>
    </section>
  </div>

<script>
  const apiInfo = document.getElementById('apiInfo');
  apiInfo.textContent = "API " + (window.API_BASE_URL || "(ë¯¸ì„¤ì •)");

  const roleInfo = document.getElementById("roleInfo");
  const boothCreateBox = document.getElementById("boothCreateBox");
  const salesInfo = document.getElementById("salesInfo");

  const keyEl = document.getElementById('adminKey');
  keyEl.value = localStorage.getItem("adminKey") || "";

  function el(id){ return document.getElementById(id); }
  function esc(s){
    return String(s).replaceAll("&","&amp;")
                    .replaceAll("<","&lt;")
                    .replaceAll(">","&gt;");
  }

  document.getElementById('saveKey').onclick = async ()=> {
    const k = keyEl.value.trim();
    if(!k) return alert("í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
    localStorage.setItem("adminKey", k);
    alert("ì €ì¥ë¨");
    await applyRoleUI();
  };

  document.getElementById('clearKey').onclick = ()=> {
    localStorage.removeItem("adminKey");
    keyEl.value="";
    alert("ì‚­ì œë¨");
    location.reload();
  };

  // âœ… ê´€ë¦¬ì ìš”ì²­ì€ api.jsë¥¼ ì•ˆ ë¯¿ê³ , ì—¬ê¸°ì„œ í—¤ë”ë¥¼ ê°•ì œë¡œ ë„£ëŠ” ë°©ì‹ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
  async function adminFetch(path, options){
    const key = (localStorage.getItem("adminKey") || "").trim();
    if(!key) throw new Error("í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤. ì €ì¥í•˜ì„¸ìš”.");
    const url = (window.API_BASE_URL || "") + (path.startsWith("/") ? path : "/"+path);
    const headers = Object.assign({}, (options?.headers||{}), {
      "X-Admin-Key": key,
      "ngrok-skip-browser-warning":"1",
      "Accept": "application/json",
    });
    return fetch(url, Object.assign({}, options, { headers }));
  }

  async function adminGet(path){
    const res = await adminFetch(path, { method:"GET", cache:"no-cache" });
    const text = await res.text();
    if(!res.ok) throw new Error(`HTTP ${res.status}\n${text}`);
    return JSON.parse(text);
  }

  async function adminPost(path, body){
    const res = await adminFetch(path, {
      method:"POST",
      cache:"no-cache",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body ?? {})
    });
    const text = await res.text();
    if(!res.ok) throw new Error(`HTTP ${res.status}\n${text}`);
    return JSON.parse(text);
  }

  async function refreshBooths(){
    const list = await apiGet("booths");

    el("boothList").innerHTML = list.length ? `
      <table>
        <thead><tr>
          <th>ì´ë¯¸ì§€</th><th>ID</th><th>ì´ë¦„</th><th>ìƒíƒœ</th><th>ì •ì›</th><th>ì„¤ëª…</th>
        </tr></thead>
        <tbody>
        ${list.map(b=>`
          <tr>
            <td>${b.imageUrl?`<img class="thumb" src="${b.imageUrl}">`:""}</td>
            <td>${esc(b.id)}</td>
            <td>${esc(b.name)}</td>
            <td>${b.isOpen ? "OPEN" : `ì¤‘ì§€(${esc(b.closedReason||"")})`}</td>
            <td>${b.capacity||0}</td>
            <td>${esc(b.description||"")}</td>
          </tr>
        `).join("")}
        </tbody>
      </table>
    ` : `<p class="muted">ë¶€ìŠ¤ ì—†ìŒ</p>`;

    const opts = list.map(b=>`<option value="${b.id}">${esc(b.name)} (${esc(b.id)})</option>`).join("");

    el("m_booth").innerHTML = `<option value="">ë¶€ìŠ¤ ì„ íƒ</option>` + opts;

    const prev = el("selBooth").value;
    el("selBooth").innerHTML = `<option value="">ë¶€ìŠ¤ ì„ íƒ</option>` + opts;
    if(prev) el("selBooth").value = prev;
  }

  async function uploadImage(fileElId, outElId){
    const f = el(fileElId).files?.[0];
    if(!f) return alert("ì´ë¯¸ì§€ ì„ íƒ");

    const fd = new FormData();
    fd.append("file", f);

    const res = await adminFetch("admin/upload", { method:"POST", body: fd });
    const j = await res.json();
    if(!res.ok || !j.ok) throw new Error(j.error || "ì—…ë¡œë“œ ì‹¤íŒ¨");
    el(outElId).value = j.url;
    alert("ì—…ë¡œë“œ ì„±ê³µ");
  }

  el("b_img_upload").onclick = async ()=> {
    try { await uploadImage("b_img", "b_img_url"); }
    catch(e){ alert("ì—…ë¡œë“œ ì‹¤íŒ¨: "+e.message); }
  };

  el("m_img_upload").onclick = async ()=> {
    try { await uploadImage("m_img", "m_img_url"); }
    catch(e){ alert("ì—…ë¡œë“œ ì‹¤íŒ¨: "+e.message); }
  };

  el("b_add").onclick = async ()=> {
    try{
      const boothKey = prompt("ì´ ë¶€ìŠ¤ ìš´ì˜ì í‚¤(ë¶€ìŠ¤í‚¤)ë¥¼ ì„¤ì •í•˜ì„¸ìš”.");
      if(boothKey === null) return;
      if(!boothKey.trim()) return alert("ë¶€ìŠ¤í‚¤ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");

      const payload = {
        id: el("b_id").value.trim(),
        name: el("b_name").value.trim(),
        description: el("b_desc").value.trim(),
        capacity: Number(el("b_cap").value || 0),
        imageUrl: el("b_img_url").value.trim(),
        adminKey: boothKey.trim()
      };

      if(!payload.id || !payload.name) return alert("ë¶€ìŠ¤ID / ì´ë¦„ í•„ìˆ˜");

      await adminPost("admin/booths", payload);
      alert("ë¶€ìŠ¤ ë“±ë¡ ì™„ë£Œ");
      await refreshBooths();
    }catch(e){
      alert("ë¶€ìŠ¤ ë“±ë¡ ì‹¤íŒ¨: " + e.message);
    }
  };

  el("m_add").onclick = async ()=> {
    try{
      const boothId = el("m_booth").value;

      const payload = {
        id: el("m_id").value.trim(),
        boothId,
        name: el("m_name").value.trim(),
        price: Number(el("m_price").value || 0),
        imageUrl: el("m_img_url").value.trim(),
        maxQty: Number(el("m_maxQty").value || 0),
        options: [] // UIì—ì„œ ì•ˆ ì“°ë‹ˆê¹Œ ë¹ˆ ë°°ì—´ë¡œ ê³ ì •
      };

      if(!payload.id || !payload.boothId || !payload.name)
        return alert("ì˜µì…˜ID / ë¶€ìŠ¤ / ì˜µì…˜ëª… í•„ìˆ˜");

      await adminPost("admin/menus", payload);
      alert("ì˜µì…˜ ë“±ë¡ ì™„ë£Œ");
    }catch(e){
      alert("ì˜µì…˜ ë“±ë¡ ì‹¤íŒ¨: "+e.message);
    }
  };

  el("m_list").onclick = async ()=> {
    try{
      const boothId = el("m_booth").value;
      if(!boothId) return alert("ë¶€ìŠ¤ ì„ íƒ");
      const res = await adminGet(`admin/menus?boothId=${encodeURIComponent(boothId)}`);
      const items = res.items || [];

      el("menuList").innerHTML = items.length ? `
      <table>
        <thead><tr>
          <th>ì´ë¯¸ì§€</th><th>ID</th><th>ì˜µì…˜(í•­ëª©)</th><th>ê°€ê²©</th><th>1ì¸ ìµœëŒ€ìˆ˜ëŸ‰</th>
        </tr></thead>
        <tbody>
          ${items.map(m=>`
            <tr>
              <td>${m.imageUrl?`<img class="thumb" src="${m.imageUrl}">`:""}</td>
              <td>${esc(m.id)}</td>
              <td>${esc(m.name)}</td>
              <td style="text-align:right">${Number(m.price||0).toLocaleString()}</td>
              <td style="text-align:center">${Number(m.maxQty||0)}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>` : `<p class="muted">ì˜µì…˜ ì—†ìŒ</p>`;
    }catch(e){
      el("menuList").innerHTML = `<p class="muted">ì˜¤ë¥˜: ${e.message}</p>`;
    }
  };

  let timer = null;

  el("selBooth").onchange = ()=> {
    if(timer) clearInterval(timer);
    renderOrders();
    if(el("selBooth").value) timer = setInterval(renderOrders, 5000);
  };

  async function setStatus(id, status){
    await adminPost("admin/reservations/status", { id, status });
  }

  function setSalesText(doneTotal, allTotal, doneCount, allCount){
    const d = doneTotal.toLocaleString();
    const a = allTotal.toLocaleString();
    salesInfo.textContent = `ë§¤ì¶œ(DONE): ${d}ì› (${doneCount}ê±´) Â· ì „ì²´: ${a}ì› (${allCount}ê±´)`;
  }

  async function renderOrders(){
    const boothId = el("selBooth").value;
    if(!boothId){
      el("resvBox").innerHTML = `<p class="muted">ë¶€ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>`;
      salesInfo.textContent = "ë§¤ì¶œ: -";
      return;
    }
    try{
      const res = await adminGet(`admin/reservations?boothId=${encodeURIComponent(boothId)}`);
      const items = res.items || [];

      // âœ… ë§¤ì¶œ ê³„ì‚°: DONE í•©ê³„ / ì „ì²´ í•©ê³„
      let doneTotal = 0, allTotal = 0, doneCount = 0, allCount = items.length;
      for(const o of items){
        const t = Number(o.total || 0);
        allTotal += t;
        if(String(o.status||"").toUpperCase() === "DONE"){
          doneTotal += t;
          doneCount += 1;
        }
      }
      setSalesText(doneTotal, allTotal, doneCount, allCount);

      if(!items.length){
        el("resvBox").innerHTML = `<p class="muted">ì˜ˆì•½ ì—†ìŒ</p>`;
        return;
      }

      el("resvBox").innerHTML = `
        <table>
          <thead>
            <tr>
              <th>ID</th><th>í•™ë²ˆ</th><th>ì´ë¦„</th><th>ì „í™”ë²ˆí˜¸</th>
              <th>ì˜µì…˜(í•­ëª©)</th><th>ê¸ˆì•¡</th><th>ìƒíƒœ</th><th>ì‹œê°</th><th>ì‘ì—…</th>
            </tr>
          </thead>
          <tbody>
            ${items.map(o=>{
              const lines = (o.items||[]).map(it=>`${it.menuId} x ${it.qty}`).join(', ');
              const doneDisabled = (o.status === "DONE" || o.status === "CANCELLED") ? "disabled" : "";
              const cancelDisabled = (o.status === "CANCELLED") ? "disabled" : "";
              return `
              <tr>
                <td>${o.id}</td>
                <td>${esc(o.studentNo)}</td>
                <td>${esc(o.studentName)}</td>
                <td>${o.phone ? esc(o.phone) : "-"}</td>
                <td>${esc(lines)}</td>
                <td style="text-align:right">${Number(o.total||0).toLocaleString()}</td>
                <td>${esc(o.status||"")}</td>
                <td>${esc(o.createdAt||"")}</td>
                <td style="white-space:nowrap">
                  <button class="btn-mini btn-done" data-id="${o.id}" ${doneDisabled}>ì²˜ë¦¬</button>
                  <button class="btn-mini btn-cancel" data-id="${o.id}" ${cancelDisabled}>ì·¨ì†Œ</button>
                </td>
              </tr>`;
            }).join("")}
          </tbody>
        </table>
      `;

      el("resvBox").querySelectorAll(".btn-done").forEach(btn=>{
        btn.onclick = async e=>{
          const id = e.target.getAttribute("data-id");
          if(!confirm(`ì˜ˆì•½(${id}) ì²˜ë¦¬ ì™„ë£Œë¡œ ë°”ê¿€ê¹Œìš”?`)) return;
          try{ await setStatus(id, "DONE"); renderOrders(); }
          catch(err){ alert("ì²˜ë¦¬ ì‹¤íŒ¨: "+err.message); }
        };
      });

      el("resvBox").querySelectorAll(".btn-cancel").forEach(btn=>{
        btn.onclick = async e=>{
          const id = e.target.getAttribute("data-id");
          if(!confirm(`ì˜ˆì•½(${id}) ì·¨ì†Œí• ê¹Œìš”?`)) return;
          try{ await setStatus(id, "CANCELLED"); renderOrders(); }
          catch(err){ alert("ì·¨ì†Œ ì‹¤íŒ¨: "+err.message); }
        };
      });

    }catch(e){
      el("resvBox").innerHTML = `<p class="muted">ì˜¤ë¥˜: ${e.message}</p>`;
    }
  }

  async function setBoothOpen(boothId, isOpen){
    let reason = "";
    if(!isOpen){
      reason = prompt("ì¤‘ì§€ ì‚¬ìœ (ì‚¬ìš©ìì—ê²Œ í‘œì‹œë¨)", "í˜„ì¬ ì£¼ë¬¸ì´ ë§ì•„ ì ì‹œ ì¤‘ì§€í•©ë‹ˆë‹¤.") || "";
    }
    await adminPost("admin/booths/status", { boothId, isOpen, reason });
    await refreshBooths();
    await renderOrders();
  }

  el("pauseBtn").onclick = async ()=> {
    const boothId = el("selBooth").value;
    if(!boothId) return alert("ë¶€ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
    try{ await setBoothOpen(boothId, false); alert("ëŒ€ê¸°ì—´ ì¤‘ì§€ë¨"); }
    catch(e){ alert("ì‹¤íŒ¨: "+e.message); }
  };

  el("resumeBtn").onclick = async ()=> {
    const boothId = el("selBooth").value;
    if(!boothId) return alert("ë¶€ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
    try{ await setBoothOpen(boothId, true); alert("ì¬ê°œë¨"); }
    catch(e){ alert("ì‹¤íŒ¨: "+e.message); }
  };

  async function applyRoleUI(){
    const key = (localStorage.getItem("adminKey") || "").trim();
    if(!key){
      roleInfo.textContent = "í‚¤ ì—†ìŒ";
      boothCreateBox.classList.remove("hide");
      await refreshBooths();
      return;
    }

    try{
      const me = await adminGet("admin/whoami");
      if(me.role === "MASTER"){
        roleInfo.textContent = "ì´ê´€ë¦¬ì(MASTER)";
        boothCreateBox.classList.remove("hide");
        await refreshBooths();
      }else{
        roleInfo.textContent = `ë¶€ìŠ¤ìš´ì˜ì(BOOTH) - ${me.allowedBoothId}`;
        boothCreateBox.classList.add("hide");

        await refreshBooths();
        el("m_booth").value = me.allowedBoothId;
        el("selBooth").value = me.allowedBoothId;
        el("m_booth").disabled = true;
        el("selBooth").disabled = true;

        renderOrders();
        if(timer) clearInterval(timer);
        timer = setInterval(renderOrders, 5000);
      }
    }catch(e){
      roleInfo.textContent = "í‚¤ ì˜¤ë¥˜";
      alert("í‚¤ í™•ì¸ í•„ìš”: " + e.message);
    }
  }

  // ë¶€ìŠ¤ ëª©ë¡/ì—­í•  ì ìš©
  refreshBooths().then(applyRoleUI);
</script>
</body>
</html>
