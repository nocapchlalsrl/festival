<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ğŸ… ì¶•ì œ ë¶€ìŠ¤ ì£¼ë¬¸/ì˜ˆì•½</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg1:#1a0b0f;      /* ì™€ì¸ ë ˆë“œ */
      --bg2:#0f1a12;      /* ë”¥ ê·¸ë¦° */
      --card:rgba(255,255,255,.12);
      --card2:rgba(255,255,255,.10);
      --border:rgba(255,255,255,.18);
      --text:#fff8f2;
      --muted:rgba(255,248,242,.72);

      --red:#e53935;
      --green:#2ecc71;
      --gold:#ffd166;

      --shadow:0 18px 55px rgba(0,0,0,.45);
      --radius:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      max-width:1080px;
      padding:22px 16px 44px;
      margin-left:auto; margin-right:auto;
      font-family: ui-sans-serif,system-ui,AppleSDGothicNeo,Segoe UI,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 900px at 10% -10%, rgba(229,57,53,.28), transparent 55%),
        radial-gradient(1000px 800px at 95% 10%, rgba(46,204,113,.22), transparent 55%),
        radial-gradient(900px 650px at 55% 0%, rgba(255,209,102,.18), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2) 55%, #070b08);
      min-height:100vh;
      overflow-x:hidden;
    }

    h1{
      margin:0 0 8px;
      font-size:28px;
      letter-spacing:-.3px;
    }
    .muted{color:var(--muted)}

    /* ìƒë‹¨ í—¤ë”(ê´€ë¦¬UI ì—†ìŒ) */
    .top{
      display:flex; align-items:center; gap:12px;
      margin-bottom:14px;
    }
    .logo{
      width:52px; height:52px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      font-size:26px;
      background: radial-gradient(circle at 30% 30%,
        rgba(255,209,102,.95),
        rgba(229,57,53,.94) 42%,
        rgba(255,255,255,.35) 82%);
      box-shadow:0 12px 35px rgba(229,57,53,.35);
      border:1px solid rgba(255,255,255,.18);
      flex:0 0 auto;
    }

    /* ì¹´ë“œ/ê·¸ë¦¬ë“œ */
    .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:14px}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute; inset:-2px -2px auto -2px;
      height:14px;
      background:linear-gradient(90deg, rgba(255,255,255,.25), rgba(255,209,102,.25), rgba(229,57,53,.20), rgba(46,204,113,.18));
      filter: blur(0.2px);
    }

    .thumb{
      width:100%;
      height:160px;
      object-fit:cover;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
    }

    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}

    input,button{
      border:1px solid rgba(255,255,255,.18);
      border-radius:14px;
      padding:11px 12px;
      font-size:14px;
      background:rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
    }
    input::placeholder{color:rgba(255,248,242,.55)}
    button{
      cursor:pointer;
      transition:.18s;
      font-weight:900;
      background:linear-gradient(135deg, rgba(229,57,53,.95), rgba(255,209,102,.92));
      color:#2b0b0c;
      box-shadow:0 14px 40px rgba(229,57,53,.28);
    }
    button:hover{transform:translateY(-1px)}
    button:disabled{opacity:.45; cursor:not-allowed; transform:none;}

    .btn-primary{
      background:linear-gradient(135deg, rgba(46,204,113,.95), rgba(255,209,102,.92));
      color:#062213;
      box-shadow:0 14px 40px rgba(46,204,113,.20);
    }

    .qty{display:flex; gap:8px; align-items:center}
    .qty button{
      width:38px; height:38px;
      border-radius:50%;
      padding:0;
      display:flex; align-items:center; justify-content:center;
      font-size:18px;
      background:linear-gradient(135deg, rgba(46,204,113,.95), rgba(255,209,102,.92));
      color:#062213;
      box-shadow:none;
    }
    .qty span{min-width:28px; text-align:center; font-weight:1000}

    .ok{
      background:rgba(46,204,113,.14);
      border:1px solid rgba(46,204,113,.30);
      color:#d9ffe9;
      padding:12px;
      border-radius:14px;
    }
    .err{
      background:rgba(229,57,53,.14);
      border:1px solid rgba(229,57,53,.35);
      color:#ffe2e2;
      padding:12px;
      border-radius:14px;
    }

    .booth-card{
      cursor:pointer;
      transition:.14s;
      border-radius:var(--radius);
      background:var(--card2);
    }
    .booth-card:hover{
      transform:translateY(-2px);
      box-shadow:0 22px 65px rgba(0,0,0,.55);
    }
    .booth-card.selected{
      border-color:rgba(255,209,102,.9);
      box-shadow:0 0 0 2px rgba(255,209,102,.45);
    }

    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.18);
      color:var(--text);
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background:var(--green);
      box-shadow:0 0 0 4px rgba(46,204,113,.15);
    }
    .dot.red{
      background:var(--red);
      box-shadow:0 0 0 4px rgba(229,57,53,.15);
    }

    /* ëˆˆ ë‚´ë¦¬ê¸°(ì•„ë˜ë¡œë§Œ ì²œì²œíˆ) */
    .snow{
      position:fixed; inset:0;
      pointer-events:none;
      opacity:.75;
      z-index:0;
    }
    .content{
      position:relative;
      z-index:1;
    }
  </style>

  <script src="js/config.js"></script>
  <script src="js/api.js"></script>
</head>

<body>
  <canvas class="snow" id="snow"></canvas>

  <div class="content">
    <div class="top">
      <div class="logo">ğŸ…</div>
      <div>
        <h1>ğŸ„ ì¶•ì œ ë¶€ìŠ¤ ì£¼ë¬¸/ì˜ˆì•½</h1>
        <div class="muted">ë¶€ìŠ¤ë¥¼ ì„ íƒí•œ ë’¤ ì˜µì…˜(ë©”ë‰´/ì¸ì›)ê³¼ ìˆ˜ëŸ‰ì„ ê³ ë¥´ê³  ì´ë¦„Â·í•™ë²ˆÂ·ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´.</div>
      </div>
    </div>

    <section class="card">
      <div class="row">
        <h2 style="margin:0">ë¶€ìŠ¤ ì„ íƒ</h2>
        <span class="muted" style="margin-left:auto">í„°ì¹˜í•´ì„œ ì„ íƒ/í•´ì œ ê°€ëŠ¥</span>
      </div>
      <div id="boothGrid" class="grid" style="margin-top:12px"></div>
    </section>

    <section class="card" style="margin-top:14px">
      <div class="row">
        <h2 style="margin:0">ì„ íƒí•œ ë¶€ìŠ¤</h2>
        <span id="boothBadge" class="badge" style="margin-left:auto; display:none;">
          <span class="dot" id="boothDot"></span>
          <span id="boothBadgeText"></span>
        </span>
      </div>
      <div id="boothInfo" style="margin-top:10px"></div>
    </section>

    <section class="card" style="margin-top:14px">
      <div class="row">
        <h2 style="margin:0">ì˜µì…˜</h2>
        <span class="muted" style="margin-left:auto" id="menuCount"></span>
      </div>
      <div id="menuGrid" class="grid" style="margin-top:12px"></div>
    </section>

    <section class="card" style="margin-top:14px">
      <div class="row">
        <h2 style="margin:0">ì£¼ë¬¸ì ì •ë³´</h2>
        <span id="sum" class="muted" style="margin-left:auto"></span>
      </div>

      <div class="row" style="margin-top:10px">
        <input id="studentName" placeholder="ì´ë¦„" style="flex:1" required>
        <input id="studentNo" placeholder="í•™ë²ˆ(4ìë¦¬)" maxlength="4" style="width:160px" inputmode="numeric" required>
        <input id="phone" placeholder="ì „í™”ë²ˆí˜¸(í•„ìˆ˜)" style="flex:1" inputmode="tel" required>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="submit" class="btn-primary">ğŸ í™•ì •í•˜ê¸°</button>
      </div>

      <div id="msg" style="margin-top:10px"></div>
    </section>
  </div>

<script>
  const boothGrid = document.getElementById('boothGrid');
  const boothInfo = document.getElementById('boothInfo');
  const menuGrid = document.getElementById('menuGrid');
  const studentName = document.getElementById('studentName');
  const studentNo = document.getElementById('studentNo');
  const phone = document.getElementById('phone');
  const submitBtn = document.getElementById('submit');
  const msg = document.getElementById('msg');
  const sumEl = document.getElementById('sum');
  const menuCount = document.getElementById('menuCount');

  const boothBadge = document.getElementById('boothBadge');
  const boothDot = document.getElementById('boothDot');
  const boothBadgeText = document.getElementById('boothBadgeText');

  let booths = [];
  let currentBooth = null;
  let menus = [];
  let qty = {}; // menuId -> number

  function esc(s){
    return String(s ?? "")
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;');
  }

  function renderBoothGrid(){
    boothGrid.innerHTML = booths.map(b=>{
      const sel = currentBooth && currentBooth.id === b.id;
      const closed = (b.isOpen === false);
      return `
        <div class="card booth-card${sel?' selected':''}"
             onclick="selectBooth('${esc(b.id)}')">
          ${b.imageUrl ? `<img class="thumb" src="${esc(b.imageUrl)}">`
                       : `<div class="thumb" style="display:flex;align-items:center;justify-content:center;color:var(--muted)">ì´ë¯¸ì§€ ì—†ìŒ</div>`}
          <div style="font-weight:1000;margin-top:10px">${esc(b.name)}</div>
          <div class="muted">${esc(b.id)}</div>
          <div class="muted" style="margin-top:6px">
            ${closed ? "â›” ëŒ€ê¸°ì—´ ì¤‘ì§€" : "âœ… ì£¼ë¬¸ ê°€ëŠ¥"}
          </div>
        </div>`;
    }).join('');
  }

  function renderBoothInfo(b){
    if(!b){
      boothInfo.innerHTML = `<p class="muted">ë¶€ìŠ¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</p>`;
      boothBadge.style.display = "none";
      return;
    }

    const isOpen = b.isOpen !== false;
    const openText = isOpen
      ? "âœ… ì£¼ë¬¸ ê°€ëŠ¥"
      : `â›” ì¤‘ì§€ë¨: ${esc(b.closedReason||"ëŒ€ê¸°ì—´ ì¤‘ì§€")}`;

    boothBadge.style.display = "inline-flex";
    boothDot.className = "dot" + (isOpen ? "" : " red");
    boothBadgeText.textContent = isOpen ? "OPEN" : "CLOSED";

    boothInfo.innerHTML = `
      <div class="row">
        <div style="flex:0 0 260px">
          ${b.imageUrl ? `<img class="thumb" src="${esc(b.imageUrl)}">` : `<div class="thumb"></div>`}
        </div>
        <div style="flex:1">
          <div style="font-size:20px;font-weight:1000">${esc(b.name)} (${esc(b.id)})</div>
          <div class="muted" style="margin-top:6px">${esc(b.description||"")}</div>
          <div class="muted" style="margin-top:6px">ì •ì›: ${b.capacity||0}</div>
          <div class="muted" style="margin-top:6px">ìƒíƒœ: ${openText}</div>
        </div>
      </div>`;
  }

  function calcSum(){
    let s = 0;
    for (const m of menus){
      s += (qty[m.id]||0) * (m.price||0);
    }
    sumEl.textContent = `í•©ê³„: ${s.toLocaleString()}ì›`;
    return s;
  }

  function renderMenus(){
    menuCount.textContent = currentBooth ? `ì´ ${menus.length}ê°œ` : "";
    menuGrid.innerHTML = menus.map(m=>{
      const q = qty[m.id]||0;
      const max = Number(m.maxQty || 0); // 0ì´ë©´ ì œí•œ ì—†ìŒ
      const plusDisabled = (max > 0 && q >= max);

      return `
      <div class="card">
        ${m.imageUrl?`<img class="thumb" src="${esc(m.imageUrl)}">`:""}
        <div style="font-weight:1000;margin-top:10px">${esc(m.name)}</div>
        <div class="muted">${Number(m.price||0).toLocaleString()}ì›</div>

        <div class="qty" style="margin-top:10px">
          <button onclick="decQty('${esc(m.id)}')">âˆ’</button>
          <span>${q}</span>
          <button onclick="incQty('${esc(m.id)}')" ${plusDisabled ? "disabled" : ""}>+</button>
        </div>

        ${max>0 ? `<div class="muted" style="margin-top:8px">1ì¸ ìµœëŒ€ ${max}ê°œ</div>`
                : `<div class="muted" style="margin-top:8px">ìˆ˜ëŸ‰ ì œí•œ ì—†ìŒ</div>`}
      </div>`;
    }).join('');

    calcSum();
  }

  window.incQty = id => {
    const m = menus.find(x => x.id === id);
    if(!m) return;
    const max = Number(m.maxQty || 0);
    const cur = qty[id] || 0;
    if(max > 0 && cur >= max) return;
    qty[id] = cur + 1;
    renderMenus();
  };

  window.decQty = id => {
    qty[id] = Math.max(0, (qty[id]||0) - 1);
    renderMenus();
  };

  window.selectBooth = async id => {
    if(currentBooth && currentBooth.id === id){
      currentBooth = null;
      menus = [];
      qty = {};
      renderBoothGrid();
      renderBoothInfo(null);
      renderMenus();
      submitBtn.disabled = false;
      msg.innerHTML = "";
      sumEl.textContent = "";
      return;
    }

    currentBooth = await apiGet(`booths/${id}`);
    menus = await apiGet(`booths/${id}/menus`);
    qty = {};

    renderBoothGrid();
    renderBoothInfo(currentBooth);
    renderMenus();

    if(currentBooth.isOpen === false){
      submitBtn.disabled = true;
      msg.innerHTML = `<div class="err">í˜„ì¬ ì´ ë¶€ìŠ¤ëŠ” ì£¼ë¬¸ì´ ì ì‹œ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.<br>${esc(currentBooth.closedReason||"")}</div>`;
    } else {
      submitBtn.disabled = false;
      msg.innerHTML = "";
    }
  };

  async function loadBooths(){
    booths = await apiGet("booths");
    renderBoothGrid();
    renderBoothInfo(null);
    renderMenus();
  }

  submitBtn.onclick = async ()=>{
    try{
      if(!currentBooth) return alert("ë¶€ìŠ¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
      if(currentBooth.isOpen === false){
        return alert(currentBooth.closedReason || "í˜„ì¬ ëŒ€ê¸°ì—´ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }

      if(!studentName.value.trim()) return alert("ì´ë¦„ì„ ì…ë ¥í•´.");
      if(!/^\d{4}$/.test(studentNo.value.trim())) return alert("í•™ë²ˆì€ ìˆ«ì 4ìë¦¬ ex)2719");
      if(!phone.value.trim()) return alert("ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´.");

      const items = menus.map(m => ({ menuId: m.id, qty: qty[m.id]||0 }))
                         .filter(it => it.qty > 0);
      if(!items.length) return alert("ì˜µì…˜ì„ ìµœì†Œ 1ê°œ ì„ íƒí•´.");

      const payload = {
        boothId: currentBooth.id,
        studentNo: studentNo.value.trim(),
        studentName: studentName.value.trim(),
        phone: phone.value.trim(),
        items
      };

      const res = await apiPost("orders", payload);
      msg.innerHTML = `<div class="ok">ğŸ‰ ì˜ˆì•½ ì™„ë£Œ! ID: ${esc(res.id)}</div>`;

      qty = {};
      renderMenus();

      studentName.value = "";
      studentNo.value = "";
      phone.value = "";
    } catch(e){
      msg.innerHTML = `<div class="err">ì˜¤ë¥˜: ${esc(e.message || e)}</div>`;
    }
  };

  // ===== ëˆˆ ì• ë‹ˆë©”ì´ì…˜ (ì•„ë˜ë¡œë§Œ ì²œì²œíˆ) =====
  (function snow(){
  const c = document.getElementById("snow");
  const ctx = c.getContext("2d");

  let W, H;
  const FLAKE_COUNT = 120;

  const flakes = [];

  function spawnFlake(randomY = true){
    return {
      x: Math.random() * W,
      y: randomY ? Math.random() * H : -10,
      r: 0.8 + Math.random() * 2.2,
      speed: 0.3 + Math.random() * 0.8
    };
  }

  function resize(){
    W = c.width = window.innerWidth;
    H = c.height = window.innerHeight;

    // ì²˜ìŒ 1ë²ˆë§Œ ì±„ìš°ê¸°
    if(flakes.length === 0){
      for(let i=0;i<FLAKE_COUNT;i++) flakes.push(spawnFlake(true));
    }
  }
  window.addEventListener("resize", resize);
  resize();

  function draw(){
    ctx.clearRect(0, 0, W, H);
    ctx.fillStyle = "rgba(255,255,255,0.9)";

    for(const f of flakes){
      f.y += f.speed;

      if(f.y > H){
        // ë¦¬ì…‹ë„ í”½ì…€ ë‹¨ìœ„ë¡œ
        f.x = Math.random() * W;
        f.y = -10;
      }

      ctx.beginPath();
      ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2);
      ctx.fill();
    }

    requestAnimationFrame(draw);
  }

  draw();
})();


 loadBooths();
</script>
</body>
</html>
